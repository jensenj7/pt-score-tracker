<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PT Score Tracker</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
</head>
<body>

<nav>
  <button onclick="showScreen('cadets')">Cadets</button>
  <button onclick="showScreen('pushups')">Pushups</button>
  <button onclick="showScreen('situps')">Situps</button>
  <button onclick="showScreen('run')">1.5 Mile</button>
  <button onclick="showScreen('sprint')">300m</button>
</nav>

<!-- CADETS -->
<div id="cadets" class="screen active">
  <h2>Cadets</h2>

  <input id="newCadetName" placeholder="Cadet name">
  <button onclick="addCadet()">Add Cadet</button>

  <ul id="cadetList"></ul>

  <div class="admin-box">
    <button class="danger" onclick="exportToExcel()">Export Scores (CSV)</button>
  </div>
</div>

<!-- PUSHUPS -->
<div id="pushups" class="screen">
  <h2>Pushups</h2>
  <div class="timer">
    <span id="pushupTimer">01:00.00</span>
    <button onclick="startPushups()">Start</button>
    <button onclick="resetPushups()">Reset</button>
  </div>

  <div id="pushupList"></div>

  <div class="admin-box">
    <button class="danger" onclick="clearPushups()">Clear Pushup Scores</button>
  </div>
</div>

<!-- SITUPS -->
<div id="situps" class="screen">
  <h2>Situps</h2>
  <div class="timer">
    <span id="situpTimer">01:00.00</span>
    <button onclick="startSitups()">Start</button>
    <button onclick="resetSitups()">Reset</button>
  </div>

  <div id="situpList"></div>

  <div class="admin-box">
    <button class="danger" onclick="clearSitups()">Clear Situp Scores</button>
  </div>
</div>

<!-- RUN -->
<div id="run" class="screen">
  <h2>1.5 Mile Run</h2>
  <div class="timer">
    <span id="runTimer">00:00.00</span>
    <button onclick="startRun()">Start</button>
    <button onclick="resetRun()">Reset</button>
  </div>

  <div id="runList"></div>

  <div class="admin-box">
    <button class="danger" onclick="clearRunScores()">Clear Run Scores</button>
  </div>
</div>

<!-- SPRINT -->
<div id="sprint" class="screen">
  <h2>300 Meter Sprint</h2>
  <div class="timer">
    <span id="sprintTimer">00:00.00</span>
    <button onclick="startSprint()">Start</button>
    <button onclick="resetSprint()">Reset</button>
  </div>

  <div id="sprintList"></div>

  <div class="admin-box">
    <button class="danger" onclick="clearSprintScores()">Clear Sprint Scores</button>
  </div>
</div>

<script>
/******************** STORAGE ********************/
const STORAGE_KEY = "PT_TRACKER_DATA";

function saveData() {
  localStorage.setItem(
    STORAGE_KEY,
    JSON.stringify({ cadets, pushupOrder, situpOrder, runOrder, sprintOrder })
  );
}

function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  const data = JSON.parse(raw);
  cadets = data.cadets || [];
  pushupOrder = data.pushupOrder || [];
  situpOrder = data.situpOrder || [];
  runOrder = data.runOrder || [];
  sprintOrder = data.sprintOrder || [];
}

/******************** DATA ********************/
let cadets = [];
let pushupOrder = [];
let situpOrder = [];
let runOrder = [];
let sprintOrder = [];

/******************** TIMERS ********************/
let pushupTime = 60000;
let situpTime = 60000;

let pushupInterval = null;
let situpInterval = null;

let runStart = null;
let runInterval = null;
let runActive = false;

let sprintStart = null;
let sprintInterval = null;
let sprintActive = false;

/******************** INIT ********************/
loadData();
document.addEventListener("DOMContentLoaded", () => renderAll());

/******************** NAV ********************/
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  renderAll();
}

/******************** CADETS ********************/
function addCadet() {
  const name = document.getElementById("newCadetName").value.trim();
  if (!name) return;

  cadets.push({
    name,
    pushups: "",
    situps: "",
    laps: 0,
    finishedRun: false,
    runTime: "",
    sprintSelected: false,
    sprintFinished: false,
    sprintTime: ""
  });

  const idx = cadets.length - 1;
  pushupOrder.push(idx);
  situpOrder.push(idx);
  runOrder.push(idx);
  sprintOrder.push(idx);

  document.getElementById("newCadetName").value = "";
  saveData();
  renderAll();
}

function deleteCadet(idx) {
  if (!confirm(`Remove ${cadets[idx].name}? This cannot be undone.`)) return;

  cadets.splice(idx, 1);

  const fix = arr => arr.filter(i => i !== idx).map(i => (i > idx ? i - 1 : i));
  pushupOrder = fix(pushupOrder);
  situpOrder = fix(situpOrder);
  runOrder = fix(runOrder);
  sprintOrder = fix(sprintOrder);

  saveData();
  renderAll();
}

/******************** TIME FORMAT ********************/
function formatTime(ms) {
  const total = ms / 1000;
  const m = String(Math.floor(total / 60)).padStart(2, "0");
  const s = String(Math.floor(total % 60)).padStart(2, "0");
  const h = String(Math.floor((total % 1) * 100)).padStart(2, "0");
  return `${m}:${s}.${h}`;
}

/******************** CLEAR PER EVENT ********************/
function clearPushups() {
  if (!confirm("Clear ALL pushup scores?")) return;
  cadets.forEach(c => (c.pushups = ""));
  saveData();
  renderPushups();
}

function clearSitups() {
  if (!confirm("Clear ALL situp scores?")) return;
  cadets.forEach(c => (c.situps = ""));
  saveData();
  renderSitups();
}

function clearRunScores() {
  if (!confirm("Clear ALL 1.5 mile run results?")) return;
  cadets.forEach(c => {
    c.laps = 0;
    c.finishedRun = false;
    c.runTime = "";
  });
  saveData();
  renderRun();
}

function clearSprintScores() {
  if (!confirm("Clear ALL 300m sprint results?")) return;
  cadets.forEach(c => {
    c.sprintTime = "";
    c.sprintFinished = false;
    c.sprintSelected = false;
  });
  saveData();
  renderSprint();
}

/******************** PUSHUPS ********************/
function startPushups() {
  clearInterval(pushupInterval);
  pushupTime = 60000;
  updatePushupTimer();

  pushupInterval = setInterval(() => {
    pushupTime -= 10;
    updatePushupTimer();
    if (pushupTime <= 0) clearInterval(pushupInterval);
  }, 10);
}

function resetPushups() {
  clearInterval(pushupInterval);
  pushupTime = 60000;
  updatePushupTimer();
}

function updatePushupTimer() {
  document.getElementById("pushupTimer").innerText = formatTime(pushupTime);
}

function renderPushups() {
  const div = document.getElementById("pushupList");
  div.innerHTML = "";

  pushupOrder.forEach(idx => {
    const c = cadets[idx];
    const row = document.createElement("div");
    row.className = "run-row";
    row.draggable = true;
    row.dataset.idx = idx;

    row.innerHTML = `
      <strong>${c.name}</strong>
      <input type="number" value="${c.pushups}"
        onchange="cadets[${idx}].pushups=this.value; saveData();">
    `;

    enableDrag(row, pushupOrder);
    div.appendChild(row);
  });
}

/******************** SITUPS ********************/
function startSitups() {
  clearInterval(situpInterval);
  situpTime = 60000;
  updateSitupTimer();

  situpInterval = setInterval(() => {
    situpTime -= 10;
    updateSitupTimer();
    if (situpTime <= 0) clearInterval(situpInterval);
  }, 10);
}

function resetSitups() {
  clearInterval(situpInterval);
  situpTime = 60000;
  updateSitupTimer();
}

function updateSitupTimer() {
  document.getElementById("situpTimer").innerText = formatTime(situpTime);
}

function renderSitups() {
  const div = document.getElementById("situpList");
  div.innerHTML = "";

  situpOrder.forEach(idx => {
    const c = cadets[idx];
    const row = document.createElement("div");
    row.className = "run-row";
    row.draggable = true;
    row.dataset.idx = idx;

    row.innerHTML = `
      <strong>${c.name}</strong>
      <input type="number" value="${c.situps}"
        onchange="cadets[${idx}].situps=this.value; saveData();">
    `;

    enableDrag(row, situpOrder);
    div.appendChild(row);
  });
}

/******************** 1.5 MILE RUN ********************/
function startRun() {
  if (runActive) return;
  runActive = true;
  runStart = Date.now();

  runInterval = setInterval(() => {
    document.getElementById("runTimer").innerText = formatTime(Date.now() - runStart);
  }, 10);
}

function resetRun() {
  clearInterval(runInterval);
  runActive = false;
  document.getElementById("runTimer").innerText = "00:00.00";
}

function addLap(idx) {
  if (runActive && !cadets[idx].finishedRun) {
    cadets[idx].laps++;
    saveData();
    renderRun();
  }
}

function stopRunner(idx) {
  if (!runActive || cadets[idx].finishedRun) return;
  cadets[idx].finishedRun = true;
  cadets[idx].runTime = formatTime(Date.now() - runStart);
  saveData();
  renderRun();
}

function renderRun() {
  const div = document.getElementById("runList");
  div.innerHTML = "";

  runOrder.forEach(idx => {
    const c = cadets[idx];
    const row = document.createElement("div");
    row.className = "run-row";
    row.draggable = true;
    row.dataset.idx = idx;

    row.innerHTML = `
      <strong>${c.name}</strong>
      | Laps: ${c.laps}
      | Time: ${c.runTime || "--:--.--"}
      <button onclick="addLap(${idx})">+Lap</button>
      <button onclick="stopRunner(${idx})">STOP</button>
    `;

    enableDrag(row, runOrder);
    div.appendChild(row);
  });
}

/******************** 300m SPRINT ********************/
function startSprint() {
  if (sprintActive) return;
  sprintActive = true;
  sprintStart = Date.now();

  sprintInterval = setInterval(() => {
    document.getElementById("sprintTimer").innerText = formatTime(Date.now() - sprintStart);
  }, 10);
}

function resetSprint() {
  clearInterval(sprintInterval);
  sprintActive = false;
  document.getElementById("sprintTimer").innerText = "00:00.00";
  cadets.forEach(c => (c.sprintSelected = false));
  saveData();
  renderSprint();
}

function stopSprint(idx) {
  const c = cadets[idx];
  if (!sprintActive || !c.sprintSelected || c.sprintFinished) return;

  c.sprintFinished = true;
  c.sprintTime = formatTime(Date.now() - sprintStart);
  saveData();
  renderSprint();
}

function renderSprint() {
  const div = document.getElementById("sprintList");
  div.innerHTML = "";

  sprintOrder.forEach(idx => {
    const c = cadets[idx];
    const row = document.createElement("div");
    row.className = "run-row";
    row.draggable = true;
    row.dataset.idx = idx;

    row.innerHTML = `
      <input type="checkbox"
        ${c.sprintSelected ? "checked" : ""}
        onchange="cadets[${idx}].sprintSelected=this.checked; saveData();">
      <strong>${c.name}</strong>
      | Time: ${c.sprintTime || "--:--.--"}
      <button onclick="stopSprint(${idx})">STOP</button>
    `;

    enableDrag(row, sprintOrder);
    div.appendChild(row);
  });
}

/******************** EXPORT ********************/
function exportToExcel() {
  let csv = "Name,Pushups,Situps,1.5 Mile Time,300m Time\n";
  cadets.forEach(c => {
    csv += `"${c.name}",${c.pushups},${c.situps},${c.runTime},${c.sprintTime}\n`;
  });

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "PT_Results.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/******************** DRAG & DROP ********************/
function enableDrag(el, orderArray) {
  el.addEventListener("dragstart", e => {
    e.dataTransfer.setData("text/plain", el.dataset.idx);
  });

  el.addEventListener("dragover", e => e.preventDefault());

  el.addEventListener("drop", e => {
    e.preventDefault();

    const dragged = Number(e.dataTransfer.getData("text/plain"));
    const target = Number(el.dataset.idx);

    const from = orderArray.indexOf(dragged);
    const to = orderArray.indexOf(target);

    orderArray.splice(to, 0, orderArray.splice(from, 1)[0]);

    saveData();
    renderAll();
  });
}

/******************** RENDER ********************/
function renderCadets() {
  const list = document.getElementById("cadetList");
  list.innerHTML = "";

  cadets.forEach((c, idx) => {
    const li = document.createElement("li");
    li.innerHTML = `${c.name} <button onclick="deleteCadet(${idx})" style="color:red;">âœ–</button>`;
    list.appendChild(li);
  });
}

function renderAll() {
  renderCadets();
  renderPushups();
  renderSitups();
  renderRun();
  renderSprint();
}
</script>

</body>
</html>
